<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//DE" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"> 
<title> test heidi</title>
</head>
<style>
div.a {
  text-align: center;
  font-family: Arial, Helvetica, sans-serif;
}
div.b {
  text-align: left;
  font-family: Arial, Helvetica, sans-serif;
}
th, td {
  padding: 5px;
}
th {
  text-align:  left;
  font-size:   0.6em;
  font-weight: normal;
  font-family: Arial, Helvetica, sans-serif;
}
hr {
  border: none;
  border-top: 3px double #333;
  color: #333;
  overflow: visible;
  text-align: center;
  height: 5px;
}
</style>


<body bgcolor="#FFFFFF" text="#000000" link="#307000" vlink="#609000">
<div class="a">
<font size="+10">Teste Heidi</font><br>
<font size="-2">(nicht was Du denkst!)</font><br><br><br>
<input type="button" onclick="GetHeidiIP()" value="Get IP"> 
<p>Heidis IP:<span id="adresse"></span></p>
</div>
<hr>
<div class="b"><font size="+2">Daten abfragen</font><br></div>
<br>
<form id="ShowFrm" action="https://sx8y7j2yhsg2vejk.myfritz.net:1083/show_data.phtml" method="get">
  <table style="width:100%">
    <tr>
      <th>Tier</th>
      <th>Startdatum</th>
      <th>Enddatum<br>1 Tag = 96 Datens&auml;tze!</th> 
      <th>Tabelle anzeigen</th>
      <th>GPX-Daten generieren</th>
    </tr>
    <tr>
      <th><input type="text" name="TrackerID" id="ShowAnim" value="0001.0001"></th>
      <th><input type="text" name="StartDate"  id="ShowStart" value="2019-01-01"></th>
      <th><input type="text" name="EndDate"    id="ShowStop" value="2019-01-02"></th> 
      <th><input type="submit" name="ShowData" value="Tabelle"></th> 
      <th><input type="submit" name="ShowData" value="GPX"></th>
    </tr>
  </table>
  <br>
</form> 
<hr>
<div class="b"><font size="+2">Pseudo-Daten generieren</font><br></div>
<hr>
<div class="b"><p>Einzeltier<br><font size="-1">Tag / Runde: <span id="AnDay">1</span> / <span id="AnRnd">0</span> <span id="AnNight"></span></font><br></p></div>
<form id="PosFrm" action="https://sx8y7j2yhsg2vejk.myfritz.net:1083/push_data.php" method="post">
  <table style="width:100%">
    <tr>
      <th>Tracker ID</th>
      <th>Longitude (geogr. L&auml;nge)</th> 
      <th>Latitude (geogr. Breite)</th>
      <th>Altitude (H&ouml;he)</th> 
    </tr>
    <tr>
      <th><input type="text" name="TrackerID" id="PosTrackerID" value="0001.0001"></th>
      <th><input type="text" name="Longitude" id="PosLongitude" value=""></th> 
      <th><input type="text" name="Latitude"  id="PosLatitude"  value=""></th>
      <th><input type="text" name="Altitude"  id="PosAltitude"  value="305"></th>
    </tr>
    <tr>
      <th>Date</th>
      <th>Time</th> 
      <th>Battery voltage</th>
      <th>Free value 1</th> 
    </tr>
    <tr>
      <th><input type="text" name="Date"     id="PosDate"     value="2019-01-01"></th>
      <th><input type="text" name="Time"     id="PosTime"     value="00:00:00"></th> 
      <th><input type="text" name="Battery"  id="PosBattery"  value="4.71"></th>
      <th><input type="text" name="FreeVal1" id="PosFreeVal1" value=""></th>
    </tr>
    <tr>
      <th>Free value 2</th> 
      <th>Free value 3</th> 
      <th>Free value 4</th> 
      <th>Free value 5</th> 
    </tr>
    <tr>
      <th><input type="text" name="FreeVal2" id="PosFreeVal2" value=""></th>
      <th><input type="text" name="FreeVal3" id="PosFreeVal3" value=""></th>
      <th><input type="text" name="FreeVal4" id="PosFreeVal4" value=""></th>
      <th><input type="text" name="FreeVal5" id="PosFreeVal5" value=""></th>
    </tr>

  </table>
  <input id="PosFromFormData" name="FromFormData" type="hidden" value="true">
  <br>
  <input type="button" onClick="InitValues()" value="Init">
  <input type="button" onClick="NewValues()" value="Neue Werte">
  <input type="submit"> 
</form> 
<hr>
<div class="b"><p>Herde<br><font size="-1">Tag / Runde: <span id="HdDay">1</span> / <span id="HdRnd">0</span> <span id="HdNight"></span></font><br></p></div>
<form id="HerdFrm">
  <table style="width:100%">
    <tr>
      <th>Anzahl Tiere</th>
      <th>Herde Longitude <br> (geogr. L&auml;nge)</th> 
      <th>Herde Latitude <br> (geogr. Breite)</th>
      <th>Tage vom Startzeitpunkt<br>(1Tag = 96Datens&auml;tze pro Tier)</th> 
    </tr>
    <tr>
      <th><input type="text" name="CowCount"   id="HerdCowCount" value="1"></th>
      <th><input type="text" name="HLongitude" id="HerdLongitude" value=""></th> 
      <th><input type="text" name="HLatitude"  id="HerdLatitude"  value=""></th>
      <th><input type="text" name="SetCount"   id="HerdSetCount"  value="1"></th>
    </tr>
    <tr>
      <th>Auswahl</th>
      <th>welches Tier</th> 
      <th>ab Tag</th>
      <th>bis Tag</th> 
    </tr>
    <tr>
      <th><input type="checkbox" name="LameAnimal"  id="HerdLameAnimal"  value=""> lahmendes Tier</th>
      <th><input type="text"     name="LameAnNo"    id="HerdLameAnNo"    value=""></th>
      <th><input type="text"     name="LameAnStart" id="HerdLameAnStart" value=""></th>
      <th><input type="text"     name="LameAnStop"  id="HerdLameAnStop"  value=""></th>
    </tr>
    <tr>
      <th><input type="checkbox" name="LowBattery"  id="HerdLowBattery"  value=""> Batterie entladen</th>
      <th><input type="text"     name="LowBatNo"    id="HerdLowBatNo"    value=""></th>
      <th><input type="text"     name="LowBatStart" id="HerdLowBatStart" value=""></th>
      <th><input type="text"     name="LowBatStop"  id="HerdLowBatStop"  value=""></th>
    </tr>
  </table>
  <br>
  <input type="button" onClick="InitHerdValues()"  value="Init">
  <input type="button" onClick="GenerateHerdMovingData()" value="Herdendaten generieren">
  <input type="button" onClick="TestPost()" value="Test Post">
</form> 
<hr>
<div class="b"><p>Debug<br><font size="-1"><br>Auswahl, was auf der Konsole (Shift^Strg^K) geloggt werden soll.</font><br>
</p></div>
<br>
<form id="DebugFrm">
  <table style="width:100%">
    <tr>
      <th><input type="checkbox" name="DoLogHerdPos"       id="DoLogHerdPos"       value=""> Herdenposition</th>
      <th><input type="checkbox" name="DoLogAnimal"        id="DoLogAnimal"        value=""> Einzeltierdaten</th>
      <th><input type="checkbox" name="DoLogExtras"        id="DoLogExtras"        value=""> Zusatzoptionen</th>
      <th><input type="checkbox" name="DoLogTransmission"  id="DoLogTransmission"  value=""> Daten&uuml;bertragung</th>
    </tr>
  </table>
  <br>
</form> 

<script>

  var conn     = new XMLHttpRequest();

  /**********************************************************************/

  /*****************     Daten generieren     ***************************/

  /**********************************************************************/

  /*---Abstand der Längengrade bei Breitengrad [111km * cos(phi)]:
      0°  111,13 km
      5°  110,71 km
      10° 109,45 km
      15° 107,35 km
      20° 104,43 km
      25° 100,72 km
      30°  96,24 km
      35°  91,04 km
      40°  85,13 km
      45°  78,58 km
      50°  71,44 km <-- 0,001 = 70m
      55°  63,74 km
      60°  55,57 km
      65°  46,97 km
      70°  38,01 km
      75°  28,76 km
      80°  19,30 km
      85°   9,69 km

      1 Breitengrad immer 111km
  -------------------------------------------*/

  var LonMax = 13.347036;
  var LonMin = 13.342940;
  var LatMax = 51.007451;
  var LatMin = 51.003918;
  var LonAnimStep = (0.01 /  35); //~20m max. 10m im Mittel
  var LatAnimStep = (0.01 /  55); //~20m max. 10m im Mittel
  var LonAnSthalf = 0.5;
  var LatAnSthalf = 0.5;

  var AnimalRounds = 0;
  var AnimalDay    = 1;
  var ChangeAnimDirAfterRound = 16; //4h

  var LonHdMin = LonMin + (LonMax - LonMin) / 20;
  var LonHdMax = LonMax - (LonMax - LonMin) / 20;
  var LatHdMin = LatMin + (LatMax - LatMin) / 20;
  var LatHdMax = LatMax - (LatMax - LatMin) / 20;
  var LonHerdStep = (0.01 / 17); //~40m max. 20m im Mittel
  var LatHerdStep = (0.01 / 27); //~40m max. 20m im Mittel
  var LonHdSthalf = 0.5;
  var LatHdSthalf = 0.5;
  
  var CurBatteryVolt = 4.6;
  var CurAltitude = 315;

  var HerdRounds = 0;
  var HerdDay    = 1;
  var ChangeHerdDirAfterRound = 24; //6h

  var RoundsPerDay = 96;

  var NaturalMovingKoeff = 1;
  var NightMovingKoeff   = 0.1;
  var NightHerdMovKoeff  = 0;
  var LameMovingKoeff    = 0.1;
  var CurAnimMovKoeff    = NaturalMovingKoeff;
  var CurHerdMovKoeff    = NaturalMovingKoeff;
  
  var pushurl  = "https://sx8y7j2yhsg2vejk.myfritz.net:1083/push_data.php";

  function TestPost()
  {
    conn.open("POST", pushurl, true);
    conn.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
    conn.onreadystatechange = function() {
      if (this.readyState == 4 && this.status == 200) {
        if(this.responseText == "OK") { 
          //setTimeout(GenerateHerdMovingDataA, 10);
        }
        this.close;
      }
    };
    //conn.send("TrackerID=9876.1235&Longitude=-13.344855&Latitude=51.006709&Altitude=305&Date=2019-06-09&Time=17:20:00&Battery=4.02");
    conn.send("ID1=9876.1235&Lo1=13.344855&La1=51.006709&Al1=305&Da1=2019-06-09&Ti1=17:20:00&Ba1=4.02&ID2=9876.1234&Lo2=13.344855&La2=51.006709&Al2=305&Da2=2019-06-09&Ti2=17:20:02&Ba2=4.02");
    if (curanim == 0){
      NewHerdPosition();
    }
  }

  
  function GetHeidiIP() {
    var xhr = new XMLHttpRequest();
    xhr.onreadystatechange = function() {
      //alert("ready state: " + this.readyState);
      //alert("status: " + this.status);
      if (this.readyState == 4 && this.status == 200) {
        document.getElementById("adresse").innerHTML = this.responseText;
        LogTrans(this.responseText);
      }
    };
    xhr.open('GET', "http://sx8y7j2yhsg2vejk.myfritz.net:1080/ip.php", true);
    xhr.send(); 
  }
  function MakeDate(d){
    var mon  = d.getMonth()+1;
    var day  = d.getDate();
    return d.getFullYear() + "-" + (mon < 10 ? "0"+ mon.toString() : mon.toString()) + "-" + (day < 10 ? "0"+ day.toString() : day.toString());
  }
  function MakeTime(d){
    var h = d.getHours();
    var m = d.getMinutes();
    var s = d.getSeconds();
    return (h < 10 ? "0"+ h.toString() : h.toString()) + ":" + (m < 10 ? "0"+ m.toString() : m.toString()) + ":" + (s < 10 ? "0"+ s.toString() : s.toString());
  }
  function DayNight(d){
    var Hour = d.getHours();
    if ((Hour >= 22) || (Hour < 6)){
      document.getElementById("HdNight").innerHTML = "(Nacht)";
      document.getElementById("AnNight").innerHTML = "(Nacht)";
      CurAnimMovKoeff = NightMovingKoeff;
      CurHerdMovKoeff = NightHerdMovKoeff; 
      if (Hour < 6) {
        NightHour = Hour + 2;
      } else {
        NightHour = Hour - 22;
      }
    } else {
      document.getElementById("HdNight").innerHTML = "";
      document.getElementById("AnNight").innerHTML = "";
      CurAnimMovKoeff = NaturalMovingKoeff;
      CurHerdMovKoeff = NaturalMovingKoeff;
      NightHour = 12 - Hour;
      if (NightHour  < 0){
        NightHour = 0;
      }
    }
    document.getElementById("PosTime").value = MakeTime(d);
    document.getElementById("PosDate").value = MakeDate(d);
  }

  function InitValues() {
    var d = new Date();
    var NewLat = LatMin + (Math.random() * (LatMax - LatMin));
    var NewLon = LonMin + (Math.random() * (LonMax - LonMin));
    DayNight(d);
    document.getElementById("PosLongitude").value = NewLon.toPrecision(8).toString();
    document.getElementById("PosLatitude").value  = NewLat.toPrecision(8).toString();
    document.getElementById("PosBattery").value   = CurBatteryVolt.toString();
    document.getElementById("PosAltitude").value  = CurAltitude.toString();
    LonAnSthalf = (Math.random() * 0.8) + 0.1;
    LatAnSthalf = (Math.random() * 0.8) + 0.1;
    //console.log("New LonAnSthalf: " + LonAnSthalf);
    //console.log("New LatAnSthalf: " + LatAnSthalf);
    AnimalRounds = 0;
    AnimalDay    = 1;
    document.getElementById("AnDay").innerHTML = AnimalDay.toString();
    document.getElementById("AnRnd").innerHTML = AnimalRounds.toString();
  }
  function NewPositionLon(){
    var CurLon = parseFloat(document.getElementById("PosLongitude").value);
    var NewLon = CurLon + ((Math.random() - LonAnSthalf) * LonAnimStep * CurAnimMovKoeff);
    if (NewLon > LonMax){
      NewLon  = LonMax;
      LonAnSthalf = (Math.random() * 0.5) + 0.5;
      LogAnimal("animal bounce MaxLon.");// New LonAnSthalf: " + LonAnSthalf);
    }
    if (NewLon < LonMin){
      NewLon  = LonMin;
      LonAnSthalf = (Math.random() * 0.5);
      LogAnimal("animal bounce MinLon.");// New LonAnSthalf: " + LonAnSthalf);
    }
    return NewLon.toPrecision(8).toString();
  }
  function NewPositionLat(){
    var CurLat = parseFloat(document.getElementById("PosLatitude").value);
    var NewLat = CurLat + ((Math.random() - LatAnSthalf) * LatAnimStep * CurAnimMovKoeff);
    if (NewLat > LatMax){
      NewLat  = LatMax;
      LatAnSthalf = (Math.random() * 0.5) + 0.5;
      LogAnimal("animal bounce MaxLat.");// New LatAnSthalf: " + LatAnSthalf);
    }
    if (NewLat < LatMin){
      NewLat  = LatMin;
      LatAnSthalf = (Math.random() * 0.5);
      LogAnimal("animal bounce MinLat.");// New LatAnSthalf: " + LatAnSthalf);
    } 
    return NewLat.toPrecision(8).toString();
  }
  function NewValues() {
    if (document.getElementById("PosLongitude").value == ""){
      InitValues();
    }
    var d = new Date(document.getElementById("PosDate").value + 'T' + document.getElementById("PosTime").value + '+00:45');
    DayNight(d);
    document.getElementById("PosLongitude").value = NewPositionLon();
    document.getElementById("PosLatitude").value  = NewPositionLat();
    var NewBatteryVolt = CurBatteryVolt - (NightHour * 0.05) + (Math.random() * 0.1) - 0.05;
    document.getElementById("PosBattery").value   = NewBatteryVolt.toPrecision(3).toString();
    document.getElementById("PosAltitude").value  = CurAltitude.toString();

    //change animals preferred direction
    AnimalRounds++;
    document.getElementById("AnRnd").innerHTML = AnimalRounds.toString();
    if((AnimalRounds % ChangeAnimDirAfterRound) == 0){
      LogAnimal("change animal preferred direction");
      LonAnSthalf = (Math.random() * 0.8) + 0.1;
      LatAnSthalf = (Math.random() * 0.8) + 0.1;
      //console.log("New LonAnSthalf: " + LonAnSthalf);
      //console.log("New LatAnSthalf: " + LatAnSthalf);
    }
    if ((AnimalRounds % RoundsPerDay) == 0){
      AnimalDay++;
      document.getElementById("AnDay").innerHTML = AnimalDay.toString();
    }
  }
  function InitHerdValues() {
    var NewLat = LatHdMin + (Math.random() * (LatHdMax - LatHdMin));
    var NewLon = LonHdMin + (Math.random() * (LonHdMax - LonHdMin));
    document.getElementById("HerdLongitude").value = NewLon.toPrecision(8).toString();
    document.getElementById("HerdLatitude").value  = NewLat.toPrecision(8).toString();
    LonHdSthalf = (Math.random() * 0.8) + 0.1;
    LatHdSthalf = (Math.random() * 0.8) + 0.1;
    //console.log("New LonHdSthalf: " + LonHdSthalf);
    //console.log("New LatHdSthalf: " + LatHdSthalf);
    HerdRounds = 0;
    HerdDay    = 1;
    loBatVolt  = 0.0;
    document.getElementById("HdDay").innerHTML = HerdDay.toString();
    document.getElementById("HdRnd").innerHTML = HerdRounds.toString();
  }
  function NewHerdPosition(){
    var CurLon  = parseFloat(document.getElementById("HerdLongitude").value);
    var NewLon  = CurLon + (((Math.random() - LonHdSthalf) * LonHerdStep) * CurHerdMovKoeff);
    var CurLat  = parseFloat(document.getElementById("HerdLatitude").value);
    var NewLat  = CurLat + (((Math.random() - LatHdSthalf) * LatHerdStep) * CurHerdMovKoeff);
    if (NewLon > LonHdMax){
      NewLon  = LonHdMax;
      LonHdSthalf = (Math.random() * 0.5) + 0.5;
      LogHerd("herd bounce MaxLon.");// New LonHdSthalf: " + LonHdSthalf);
    }
    if (NewLon < LonHdMin){
      NewLon  = LonHdMin;
      LonHdSthalf = (Math.random() * 0.5);
      LogHerd("herd bounce MinLon.");// New LonHdSthalf: " + LonHdSthalf);
    }
    document.getElementById("HerdLongitude").value = NewLon.toPrecision(8).toString();
    if (NewLat > LatHdMax){
      NewLat  = LatHdMax;
      LatHdSthalf = (Math.random() * 0.5) + 0.5;
      LogHerd("herd bounce MaxLat.");// New LatHdSthalf: " + LatHdSthalf);
    }
    if (NewLat < LatHdMin){
      NewLat  = LatHdMin;
      LatHdSthalf = (Math.random() * 0.5);
      LogHerd("herd bounce MinLat.");// New LatHdSthalf: " + LatHdSthalf);
    } 
    document.getElementById("HerdLatitude").value = NewLat.toPrecision(8).toString();
    LogHerd("Herd position (lon / lat): " + NewLon.toPrecision(8).toString() + " / " + NewLat.toPrecision(8).toString());

  }
  function NewHerdMovPositionLon(CowNo){
    var NewLon;
    var CurLon = parseFloat(document.getElementById("HerdLongitude").value);
    if((lame == 1) && (CowNo == lameNo) && (HerdDay >= lameSta) && (HerdDay <= lameEnd)){
      NewLon = CurLon + ((Math.random() - 0.5) * LonAnimStep * CurAnimMovKoeff * LameMovingKoeff);
      LogExtra("lame cow " + CowNo);
    } else {
      NewLon = CurLon + ((Math.random() - 0.5) * LonAnimStep * CurAnimMovKoeff);
    }
    NewLon = (NewLon > LonMax) ? LonMax : NewLon; 
    NewLon = (NewLon < LonMin) ? LonMin : NewLon; 
    return NewLon.toPrecision(8).toString();
  }
  function NewHerdMovPositionLat(CowNo){
    var NewLat = 0;
    var CurLat = parseFloat(document.getElementById("HerdLatitude").value);
    if((lame == 1) && (CowNo == lameNo) && (HerdDay >= lameSta) && (HerdDay <= lameEnd)){
      NewLat = CurLat + ((Math.random() - 0.5) * LatAnimStep * CurAnimMovKoeff * LameMovingKoeff);
    } else {
      NewLat = CurLat + ((Math.random() - 0.5) * LatAnimStep * CurAnimMovKoeff);
    }
    NewLat = (NewLat > LatMax) ? LatMax : NewLat; 
    NewLat = (NewLat < LatMin) ? LatMin : NewLat; 
    return NewLat.toPrecision(8).toString();
  }
  
  var loBatVolt = 0.0;
  function NewHerdMovingValues(CowNo) {
    var NewBatteryVolt = 0.0;
    var DeadModule     = false;

    if((loBat == 1) && (CowNo == loBatNo) && (HerdDay >= loBatSta) && (HerdDay <= loBatEnd)){
      if(loBatVal == 0.0){
        loBatVal = CurBatteryVolt;
        LogExtra("start battery low down on cow: " + CowNo);
      } else {
        if (loBatVal >= 3.3) {
          loBatVal -= 0.0015;
          LogExtra("battery on cow " + CowNo + ": " + loBatVal.toPrecision(3).toString() + "V");
        } else {
          DeadModule = true;
          LogExtra("dead module on cow: " + CowNo);
        }
      }
      NewBatteryVolt = loBatVolt;
    } else {
      NewBatteryVolt = CurBatteryVolt - (NightHour * 0.05) + (Math.random() * 0.1) - 0.05;
    }
    if (DeadModule){
      document.getElementById("PosLongitude").value = "";
      document.getElementById("PosLatitude").value  = "";
      document.getElementById("PosBattery").value   = "";
      document.getElementById("PosAltitude").value  = "";
    } else {
      document.getElementById("PosLongitude").value = NewHerdMovPositionLon(CowNo);
      document.getElementById("PosLatitude").value  = NewHerdMovPositionLat(CowNo);
      document.getElementById("PosBattery").value   = NewBatteryVolt.toPrecision(3).toString();
      document.getElementById("PosAltitude").value  = CurAltitude.toString();  
    }

    var IDH = CowNo.toString();
    if(IDH.length == 1){
      IDH = "0001.000" + IDH;
    }else
    if(IDH.length == 2){
      IDH = "0001.00" + IDH;
    }else
    if(IDH.length == 3){
      IDH = "0001.0" + IDH;
    }else
    if(IDH.length >= 4){
      IDH = "0001." + IDH;
    }
    document.getElementById("PosTrackerID").value = IDH;
  }
  
  var animals  = 0;
  var curanim  = 0;
  var possets  = 0;
  var lame     = 0;
  var lameNo   = 0;
  var lameSta  = 0;
  var lameEnd  = 0;
  var loBat    = 0;
  var loBatNo  = 0;
  var loBatSta = 0;
  var loBatEnd = 0;
  var loBatVal = 0.0;
  var NightHour = 0;
  
  function GenerateHerdMovingData() {
    animals = parseInt(document.getElementById("HerdCowCount").value);
    possets = parseInt(document.getElementById("HerdSetCount").value) * RoundsPerDay;
    curanim = 0;
    if (document.getElementById("PosLongitude").value == ""){
      InitValues();
    }
    if (document.getElementById("HerdLongitude").value == ""){
      InitHerdValues();
    }
    lame = 0;
    if (document.getElementById("HerdLameAnimal").checked){
      lameNo  = parseInt(document.getElementById("HerdLameAnNo").value);
      lameSta = parseInt(document.getElementById("HerdLameAnStart").value);
      lameEnd = parseInt(document.getElementById("HerdLameAnStop").value);
      if ((lameNo >= 1) && (lameSta >= 1) && (lameEnd  >=1)){
        lame = 1;
        LogExtra("consider lame animal event");
      }
    } 
    loBat = 0;
    if (document.getElementById("HerdLowBattery").checked){
      loBatNo  = parseInt(document.getElementById("HerdLowBatNo").value);
      loBatSta = parseInt(document.getElementById("HerdLowBatStart").value);
      loBatEnd = parseInt(document.getElementById("HerdLowBatStop").value);
      if ((loBatNo >= 1) && (loBatSta >= 1) && (loBatEnd  >=1)){
        loBat = 1;
        loBatVal = 0.0;
        LogExtra("consider low battery event");
      }
    } 
    setTimeout(GenerateHerdMovingDataA, 10); //start moving
  }
  
  function GenerateHerdMovingDataA()
  {
    if(possets > 0){
      curanim++;
      NewHerdMovingValues(curanim);
      if(curanim == animals){
        curanim = 0;
        possets--;
        var d = new Date(document.getElementById("PosDate").value + 'T' + document.getElementById("PosTime").value + '+00:45');
        DayNight(d);
        //change herd preferred direction
        HerdRounds++;
        document.getElementById("HdRnd").innerHTML = HerdRounds.toString();
        if((HerdRounds % ChangeHerdDirAfterRound) == 0 ){
          LogHerd("change herd preferred direction");
          LonHdSthalf = (Math.random() * 0.8) + 0.1;
          LatHdSthalf = (Math.random() * 0.8) + 0.1;
          //console.log("New LonHdSthalf: " + LonHdSthalf);
          //console.log("New LatHdSthalf: " + LatHdSthalf);
        }
        if ((HerdRounds % RoundsPerDay) == 0){
          HerdDay++;
          document.getElementById("HdDay").innerHTML = HerdDay.toString();
        }
      }
      setTimeout(GenerateHerdMovingDataB, 10);
    } else {
    }
  }
  
  function GenerateHerdMovingDataB()
  {
    var params = GetPostParams();
      LogTrans(params);
    conn.open("POST", pushurl, true);
    conn.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
    conn.onreadystatechange = function() {
      if (this.readyState == 4 && this.status == 200) {
        LogTrans(this.responseText);
        if(this.responseText == "OK") { 
          setTimeout(GenerateHerdMovingDataA, 10);
        }
        this.close;
      }
    };
    conn.send(params);
    if (curanim == 0){
      NewHerdPosition();
    }
  }

  function GetPostParams(){
    var params = "";
    var elem = document.getElementById('PosFrm').elements;
    var dead = false;

    for(var i = 0; i < elem.length; i++){
      if(elem[i].type == "text"){
        if(params.length > 0){
          params += "&";
        }
        if ((i == 2) && (elem[i].value.length == 0)){
          dead = true;
        }
        if ((i >= 2) && dead){
          params += elem[i].name + "=";       
        } else {
          params += elem[i].name + "=" + elem[i].value;
        }
      }
    } 
    return(params);
  }
  
  function LogHerd(text){
    if (document.getElementById("DoLogHerdPos").checked){
      console.log(text);
    }
  }
  function LogAnimal(text){
    if (document.getElementById("DoLogAnimal").checked){
      console.log(text);
    }
  }
  function LogExtra(text){
    if (document.getElementById("DoLogExtras").checked){
      console.log(text);
    }
  }
  function LogTrans(text){
    if (document.getElementById("DoLogTransmission").checked){
      console.log(text);
    }
  }

</script>
</body>
</html>
